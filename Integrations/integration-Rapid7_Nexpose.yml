commonfields:
  id: Rapid7 Nexpose
  version: -1
name: Rapid7 Nexpose
display: Rapid7 Nexpose
category: Authentication
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAF8ElEQVRo3tVaa2wUVRQ+lUeolLZQHwQxEUIi/GgpakvTst2d7fax7RaEUFOIRW2x7e7cme220BawNSQ1MQZFgYaH8gvlFVAxUYIIJPxRA7FSLCpBJMYnL5FEyh8cvzttodvd6e527izpJCezO3Pn3Pvde853zzkzRKKPAmUOScp+Kg/MoVF7FCiZJLHz5JA1nL8jlzxzxLoklgw908iBc5xBZKPTSzqIAcmvPU3Ltk+NSc/S5vGUz9YASBd0XIXOb2jpKm+cQDAnOvw9CAQXm1ej0ubj9PW5yVHpaXplLJU3bKN83xA9+F+gtJAnkGAdCIm50dm1EBADYgeYrJrDlF0d2UTscj7ZfXcMdN2kJW2PWwPCIZdC/jYEESwHATopwsquHVZHgb9IPAinvhI3owTRJ5L8ITm8xisjye8N+7xLtQk2JyUHPnElJhB3CcB7hCpff9TATI8bPmfzXUCfqeJAuPyzoPinEYEYkMKGr8jtnztkhbmZ3gr1MYiTXaPFgWKRFDuenMpBUyD0wemsBGqVt2EVWmgRmMoh3wjTthdAdlGpP120cz8EO/7FNJBQswm95mR7qKTBoujAqUzADJ4QDiREWDe5lInWbn5FgWysyiEAOmNgDuZFkt+N107+AGw3hUrU6VSsLsTvo4LBHMFEJVDcD7syBh1vEQikFz5SRPflkNRU2PY5cebF/oBPLjM/sMWBVEShKpRuJxeLjsMdyibx/sL2UUXHCNmrtiUZ9n/0bhSaW3uL1A2RuVxiqy1ismvQvR7ycKxx1GuUP0hRdo1GLVvfjsK8NlpMzRdhbowKlSmRQVSumg/kt4csr0Y5dZepyvuEMXh/Ctr1kA1t56vDC28jmaLnbkQZ9VSoJhqxzzh08rmhguyXPqI9xxINzOotPsDkhbXavMZlWmZgeVjh93gbHYx5//kWYFZQkfLg0P2hAg3+M3xwQb1GFe0nacVaDz3XOB3m9xiU5UP64i/M9rzG5dq+6xnanqsZ2u4rc4OEX+P3eBt9ZYQRgnf/4IAwERe7IsyARnl1PBTX9IRKYteD7mNwfNb5gD+4nKG9/9fcIOHX+D3eRggQbp42Pp616wYBUVeaVtwPhM8+H/iuPzODhF/j94QB4RNaFviR1h1K6wPxYkcyZvqHUQckC2y6utN3bzWatzDKqtZGHZDcuh56oWNSH4h3dqRRSdP5frsfXUAkVn1vNTxyO+V5zfG6GGe/ohMIn1BOKFJEej5NBfKEwfHRAWE0OBL6ldh+0H4ussRpOqVXrfFQRdtJneqN+7qD+G9J8N7hbkzEalRBusynrDFuiE7lzbCbK990s6s/Ns732WGkweMMQgxs95JSB0BnzPF61CHKWVC+cY1rZWAG5fmuhs1Vlq96JprsbzLyZRmoL1gaADrZGxHHsiSwKagwwUtDLmV9rBEwKiasvb9sY0FezgIRx/BsUybCoN5Bz32G2CppZLlJTfNssrO94sEoG6MrCLIytN8KS/EB/CQBNS1WCflNIJgeOHvKfcrLlULd2YT5ibwZ5zHxB+JAicbBjgg1MV5KcjcuIk/TdFBrKnwzTsCcyk6LmIynBd04f0Lu1qctNi05CZ2dtbxkKiknyNmQaA0Il5qOTkLDmZyXrQDzMyRNLACPmgmlu+Ebt0MTG991Yhs6sUM34n6nvufYTfsMJ4G9VMjGigNR0+LRbTf84P4lW31wWdOtZlCx8qUpMPw9fZEyUxyI1rYpCA8uGQ5Kkr8I+5y39RFa4Ds8QiCXwVpZYk2q1C9FeIexw/BZm5yMmY01PbgBJ7egcF3oLxnWjl1Kc4Ty6USAPRBDSbTYGpZqacMGJf8TvnqBxEaS8yLqyKpJhnyqfzRgHPrzzzQsfIWweE0CuHw12euHMpVG5f7N+Nwiuh2Yf77hbj6mf84Rap6/YoO1x2cnL3m1Dp2e0h1RwtkuB5CSxhZGPL9zKj4UONX/NncAxEWS/E/FOcaSJ+mfHDlNhNFlrTP0l5x9weL38LF0GrWHq2m2/uLGpT4pWvX/zRDqQjZWrVoAAAAASUVORK5CYII=
description: Rapid7’s on-premise vulnerability management solution, Nexpose, helps
  you reduce your threat exposure by enabling you to assess and respond to changes
  in your environment real time and prioritizing risk across vulnerabilities, configurations,
  and controls.
configuration:
- display: Server URL (e.g. https://192.168.0.1:8080)
  name: server
  defaultvalue: ""
  type: 0
  required: true
- display: Username
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: Do not validate server certificate (insecure)
  name: insecure
  defaultvalue: "false"
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: "false"
  type: 8
  required: false
- display: 2FA token
  name: token
  defaultvalue: ""
  type: 0
  required: false
script:
  script: |
    var SERVER_URL = params.server.replace(/[\/]+$/, '') + '/api/3/';
    var AUTH = basicAuth(params.credentials.identifier, params.credentials.password);
    var TOKEN = params.token;

    function getHeaders(){
        var headers = {
                    'Authorization': [AUTH],
                    'Content-Type': ['application/json'],
                };
        if(TOKEN){
            headers['Token'] = TOKEN;
        }

        return headers;
    }

    function sendRequest(path, method, queryParams, body){
        var query = '';
        if(queryParams){
            query = encodeToURLQuery(queryParams);
        }

        var url = SERVER_URL.concat(path, query);
        var res = http(
            url,
            {
                Method: method ? method : 'GET',
                Headers: getHeaders(),
                Body: body ? JSON.stringify(body) : body
            },
            params.insecure,
            params.proxy
        );
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Failed on request ' + url + ' , request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
        }
        return JSON.parse(res.Body);
    }

    function getListResponse(path, queryParams){
        var finalResult = [];
        var pageDiff = 0;
        var pageNumber = 0;
        do{
            queryParams.page = pageNumber++;
            var response = sendRequest(path, 'GET', queryParams);
            if(!response){
                break;
            }
            finalResult = finalResult.concat(response.resources);
            if(response.page){
                pageDiff = response.page.totalPages - response.page.number;
            }
        }while(pageDiff > 1 && !queryParams.size);

        return finalResult;
    }

    function getAssetsCommand(){
        var assets = getAssets(args);
        var entry = {
            Type: entryTypes.note,
            Contents: assets,
            ContentsFormat: formats.json
        };


        entry.ReadableContentsFormat = formats.markdown;
        entry.HumanReadable = tableToMarkdown('Assets' , assets);
        entry.EntryContext = {
            'Nexpose.Asset(val.id==obj.id)': assets
        };

        return entry;
    }

    function getAssetCommand(){
        var assets = getAssets(args, args.id);
        delete(args.id);
        var entry = {
            Type: entryTypes.note,
            Contents: assets,
            ContentsFormat: formats.json
        };

        entry.ReadableContentsFormat = formats.markdown;
        entry.HumanReadable = tableToMarkdown('Asset' , assets);
        entry.EntryContext = {
            'Nexpose.Asset(val.id==obj.id)': assets
        }

        return entry;
    }

    function getAssets(queryParams, id){
        var path = 'assets';
        if(id){
            path += "/" + id;
        }
        else{
            return getListResponse(path, queryParams);
        }

        log(path);
        return sendRequest(path, 'GET', queryParams);
    }

    var entry;

    switch (command) {
        // This is the call made when pressing the integration test button.
        case 'test-module':
            return 'ok';
        case 'fetch-incidents':
            // JSON of the incident type created by this integration
            // You can store the last run as a string using set last run.
            setLastRun({'time': 'now'});
            // And you can retrieve it in any other call...
            var now = getLastRun();
            // now is an object with field time, that has value 'now'.
            return JSON.stringify([{"Name":"Incident #1"},{"Name":"Incident #2"}]);
        case 'nexpose-get-assets':
            var entry = getAssetsCommand();
            break;
         case 'nexpose-get-asset':
            var entry = getAssetCommand();
            break;
    }

    return entry;
  type: javascript
  commands:
  - name: nexpose-get-assets
    arguments:
    - name: sort
      description: 'The criteria to sort the records by, in the format: property[,ASC|DESC].
        The default sort order is ascending. Multiple sort criteria can be specified
        using multiple sort query parameters.'
    - name: size
      description: integer <int32> The number of records per page to retrieve.ß
    description: Returns all assets for which you have access.
  - name: nexpose-get-asset
    arguments:
    - name: id
      required: true
      description: integer <int64> The identifier of the asset.
    description: Returns the specified asset.
  runonce: false
releaseNotes: "-"